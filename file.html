<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
  <title>前端图片压缩上传</title>
</head>

<body>
  <form id="form">
    <input type="file" id="file" />
  </form>
</body>
<script>
!(function() {
  if (!HTMLCanvasElement.prototype.toBlob) {
    Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
      value: function(callback, type, quality) {
        var binStr = atob(this.toDataURL(type, quality).split(',')[1]),
          len = binStr.length,
          arr = new Uint8Array(len);
        for (var i = 0; i < len; i++) {
          arr[i] = binStr.charCodeAt(i);
        }
        callback(new Blob([arr], {
          type: type || 'image/png'
        }));
      }
    });
  }

  function merge(target) {
    for (var i = 1, j = arguments.length; i < j; i++) {
      var source = arguments[i] || {};
      for (var prop in source) {
        if (source.hasOwnProperty(prop)) {
          var value = source[prop];
          if (value !== undefined) {
            target[prop] = value;
          }
        }
      }
    }
    return target;
  };

  function readerImg(file, callback) {
    // 1.读取文件详细信息
    // 2.使用FileReader读取文件信息
    var reader = new FileReader();
    // 4.监听读取文件过程方法,异步过程
    reader.onloadstart = function(e) {};
    reader.onprogress = function(e) {};
    reader.onabort = function(e) {};
    reader.onerror = function(e) {};
    reader.onload = function(e) {
      var img = document.createElement("img");
      // 将解析的base64字符串赋值给img标签
      img.onload = function() {
        callback(img);
      };
      img.src = e.target.result;
    };
    //3 开始读取
    reader.readAsDataURL(file);
  }

  function MyUploader(options) {
    if (!(this instanceof MyUploader)) {
      return new MyUploader(options);
    }
    var defaults = {
      url: '', // 上传url
      maxWidth: 400, // 最大尺寸限制
      maxHeight: 400, // 最大尺寸限制
      extraParameter: {}, //额外的参数
      successHandler: function() {},
      errorHandler: function() {},
      selectHandler: function(blob) {}
    }
    var opts = merge({}, defaults, options)
    this.options = opts
    var _this = this;
    this.options.el.onchange = function(e) {
      _this.fileChange(e)
    };
  }

  MyUploader.prototype.upload = function upload(file) {
    var url = this.options.url;
    var extraParameter = this.options.extraParameter;
    var _this = this;
    var formData = new FormData();
    formData.append('file', file, +new Date() + '.jpg'); // 需添加第三个参数filename
    for (var k in extraParameter) { // 添加额外的参数
      formData.append(k, extraParameter[k])
    }
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.withCredentials = true;
    xhr.onreadystatechange = function() {
      if (this.status == 200) {
        if (this.readyState == 4) {
          _this.options.successHandler(JSON.parse(xhr.responseText))
        }
      } else {
        _this.options.errorHandler(xhr.responseText)
      }
    };
    xhr.send(formData);
  }
  MyUploader.prototype.fileChange = function fileChange(e) {
    var maxWidth = this.options.maxWidth;
    var maxHeight = this.options.maxHeight;
    var url = this.options.url;
    var extraParameter = this.options.extraParameter;
    var _this = this;

    var file = e.target.files[0]; // IE10+
    readerImg(file, function(img) {
      console.log(img.width, img.height);
      // 缩放图片需要的canvas
      var canvas = document.createElement('canvas');
      var context = canvas.getContext('2d');
      // 图片原始尺寸
      var originWidth = img.width;
      var originHeight = img.height;

      // 目标尺寸
      var targetWidth = originWidth,
        targetHeight = originHeight;
      // 图片尺寸超过400x400的限制
      if (originWidth > maxWidth || originHeight > maxHeight) {
        if (originWidth / originHeight > maxWidth / maxHeight) {
          // 更宽，按照宽度限定尺寸
          targetWidth = maxWidth;
          targetHeight = Math.round(maxWidth * (originHeight / originWidth));
        } else {
          targetHeight = maxHeight;
          targetWidth = Math.round(maxHeight * (originWidth / originHeight));
        }
      }
      // canvas对图片进行缩放
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      // 清除画布
      context.clearRect(0, 0, targetWidth, targetHeight);
      // 图片压缩
      context.drawImage(img, 0, 0, targetWidth, targetHeight);
      // canvas转为blob并上传
      canvas.toBlob(function(blob) {
        _this.options.selectHandler.call(_this, blob);
      }, file.type || 'image/jpeg');
    });
  };

  window.MyUploader = MyUploader;
})();
</script>
<script>
$.post('/api/v1/admin/login', {
  userName: 'zjadmin', //  zjadmin
  password: '123456', //  123456
  captcha: '12345',
  rememberMe: false
}, function(res) {
  console.log(res)
})


MyUploader({
  el: document.getElementById('file'),
  url: '/api/v1/admin/common/file/upload',
  selectHandler: function(blob) {
    console.log(this)
    this.upload(blob)
  },
  successHandler: function(res) {
    console.log(res)
  }
})
</script>

</html>
