<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <title>裁剪图片</title>
  <link href="https://cdn.bootcss.com/cropper/3.1.3/cropper.min.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <style>
  .m-copper-wrap {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    height: 100%;
    width: 100%;
    padding: 0;
    background-color: rgba(25, 28, 34, 0.88);
    text-align: center;
    font-size: 0;
    overflow: auto;
    z-index: 3000;
    white-space: nowrap;
  }
  
  .m-copper-wrap:after {
    content: '';
    display: inline-block;
    width: 0;
    height: 90%;
    vertical-align: middle;
  }
  
  .m-copper-wrap .m-copper {
    display: inline-block;
    text-align: left;
    border-radius: 4px;
    background-color: #fff;
    vertical-align: middle;
    outline: 0;
    position: relative;
    font-size: 14px;
    width: auto;
    white-space: normal;
  }
  
  .m-copper-wrap .m-copper .body {
    padding: 15px;
    overflow: auto;
    min-width: 300px;
    max-width: 700px;
    min-height: 60px;
    max-height: 80vh;
  }
  
  .m-copper-wrap .m-copper .footer {
    padding: 10px 15px;
    text-align: right;
  }
  </style>
</head>

<body>
  <div class="container">
    <label for="input" class="btn btn-danger">
      <span>选择图片</span>
      <input type="file" id="input" class="sr-only" ac>
    </label>
    <label for="input1" class="btn btn-primary">
      <span>选择图片</span>
      <input type="file" id="input1" class="sr-only" ac>
    </label>
  </div>
<!--   <div class="m-copper-wrap">
    <div class="m-copper">
      <div class="body">
        <img src="" class="photo">
      </div>
      <div class="footer">
        <button class="btn btn-default" type="button" data-action="cancel">取消</button>
        <button class="btn btn-primary" type="button" data-action="upload">确定上传</button>
      </div>
    </div>
  </div> -->
  <!-- Scripts -->
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/cropper/3.1.3/cropper.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script>
  !(function() {
    function createHtml() {
      var html = $('<div class="m-copper-wrap">\
        <div class="m-copper">\
          <div class="body">\
            <img src="" class="photo">\
          </div>\
          <div class="footer">\
            <button class="btn btn-default" type="button" data-action="cancel">取消</button>\
            <button class="btn btn-primary" type="button" data-action="upload">确定上传</button>\
          </div>\
        </div>\
      </div>');
      return html;
    }
    function CropperInit(input, opts) {
      var $dom = createHtml();
      $('body').append($dom);
      var baseWidth;
      var baseHeight;
      var $image = $dom.find('.photo');
      var options = {        
        aspectRatio: 1, // 纵横比
        viewMode: 2
      };
      var _opts = $.extend({}, {
        uploadSuccess: $.noop,
        cropSuccess: $.noop,
        fileName: 'file',
        url: '',
        width: '500'
      }, opts)
      this._opts = _opts;
      var _this = this;
      this.$dom = $dom;
      this.$image = $image;
      this.$inputImage = input;
      this.$image.cropper(options);     
      var uploadedImageURL;      
      if (URL) {         // 给input添加监听
        this.$inputImage.change(function() {          
          var files = this.files;          
          var file;          
          if (!_this.$image.data('cropper')) {            
            return;          
          }          
          if (files && files.length) {            
            file = files[0];
            if (/^image\/\w+$/.test(file.type)) { // 判断是否是图像文件
              readerImg(file, function(img) {
                uploadedImageURL = URL.createObjectURL(file);
                baseWidth = img.width;
                baseHeight = img.height;
                if (img.width < 450 || img.height < 450) {
                  window.alert('图片宽和高不能小于450像素');
                  _this.$inputImage.val('');
                  return;
                }
                _this.$image.cropper('destroy').attr('src', uploadedImageURL).cropper(options);
                _this.$inputImage.val('');
                _this.$dom.show()
              })
            } else {             
              window.alert('请选择一个图像文件！');           
            }         
          }       
        });      
      } else {        
        _this.$inputImage.prop('disabled', true).addClass('disabled');      
      }
      this.$dom.on('click', '[data-action="upload"]', function() {
        _this.send()
      })

      this.$dom.on('click', '[data-action="cancel"]', function() {
        _this.$dom.hide();
      })
    }
    CropperInit.prototype.send = function() {
      var _this = this;
      this.$image.cropper('getCroppedCanvas', {        
        width: 450,
        height: 450
      }).toBlob(function(blob) {
        blobToDataURL(blob, function(base64) {
          _this.sendImg(blob, base64)
        })
      }, 'image/jpeg');
    }

    CropperInit.prototype.sendImg = function(file, base64) {
      var _this = this;
      var formData = new FormData();
      formData.append(this._opts.fileName, file, +new Date() + '.jpg');
      var xhr = new XMLHttpRequest();
      xhr.open('POST', this._opts.url, true);
      xhr.withCredentials = true;
      xhr.onreadystatechange = function() {
        if (this.status == 200) {
          if (this.readyState == 4) {
            _this._opts.uploadSuccess(JSON.parse(xhr.responseText), base64);
            _this.$dom.hide();
          }
        } else {

        }
      };
      xhr.send(formData);
    };

    function blobToDataURL(blob, callback) {
      var a = new FileReader();
      a.onload = function(e) {
        callback(e.target.result);
      }
      a.readAsDataURL(blob);
    }


    function readerImg(file, callback) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var img = document.createElement("img");
        // 将解析的base64字符串赋值给img标签
        img.onload = function() {
          callback(img);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    if (!HTMLCanvasElement.prototype.toBlob) {
      Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
        value: function(callback, type, quality) {
          var binStr = atob(this.toDataURL(type, quality).split(',')[1]),
            len = binStr.length,
            arr = new Uint8Array(len);
          for (var i = 0; i < len; i++) {
            arr[i] = binStr.charCodeAt(i);
          }
          callback(new Blob([arr], {
            type: type || 'image/png'
          }));
        }
      });
    }

    window.CropperInit = CropperInit;
    $.cropperInit = function(input, opts) {
      return new CropperInit(input, opts)
    }
  })();

  </script>
  <script>
  $.post('/api/v1/admin/login', {
    userName: 'zjadmin', //  zjadmin
    password: '123456', //  123456
    captcha: '12345',
    rememberMe: false
  }, function(res) {
    console.log(res)
  })

  var a = $.cropperInit($('#input'), {
    url: '/api/v1/admin/common/file/upload',
    uploadSuccess: function(res, base64) {
      //上传成功回调
      console.log('1', res);
    }
  });

  var b = new CropperInit($('#input1'), {
    url: '/api/v1/admin/common/file/upload',
    uploadSuccess: function(res, base64) {
      //上传成功回调
      console.log('2', res);
    }
  });
  </script>
</body>

</html>
