<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <title>裁剪图片</title>
  <link href="https://cdn.bootcss.com/cropper/3.1.3/cropper.min.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <style>
  .m-copper-wrap {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    height: 100%;
    width: 100%;
    padding: 0;
    background-color: rgba(25, 28, 34, 0.88);
    text-align: center;
    font-size: 0;
    overflow: auto;
    z-index: 3000;
    white-space: nowrap;
  }
  
  .m-copper-wrap:after {
    content: '';
    display: inline-block;
    width: 0;
    height: 90%;
    vertical-align: middle;
  }
  
  .m-copper-wrap .m-copper {
    display: inline-block;
    text-align: left;
    border-radius: 4px;
    background-color: #fff;
    vertical-align: middle;
    outline: 0;
    position: relative;
    font-size: 14px;
    width: auto;
    white-space: normal;
  }
  
  .m-copper-wrap .m-copper .body {
    padding: 15px;
    overflow: auto;
    min-width: 300px;
    max-width: 700px;
    min-height: 60px;
    max-height: 80vh;
  }
  
  .m-copper-wrap .m-copper .footer {
    padding: 10px 15px;
    text-align: right;
  }
  </style>
</head>

<body>
  <div class="container">
    <label for="input" class="btn btn-danger" id="">
      <span>选择图片</span>
      <input type="file" id="input" class="sr-only" ac>
    </label>
  </div>
  <div class="m-copper-wrap">
    <div class="m-copper">
      <div class="body">
        <img src="" class="photo">
      </div>
      <div class="footer">
        <button class="btn btn-default" type="button" data-action="cancel">取消</button>
        <button class="btn btn-primary" type="button" data-action="cropper">确定裁剪</button>
        <button class="btn btn-primary" type="button" data-action="upload">确定上传</button>
      </div>
    </div>
  </div>
  <!-- Scripts -->
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/cropper/3.1.3/cropper.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script>
  // 修改自官方demo的js
      
  $.cropperInit = function(input, opts) {
    var baseWidth;
    var baseHeight;
    var $image = $('body').find('.m-copper-wrap .photo');
    var options = {        
      aspectRatio: 1, // 纵横比
      viewMode: 2
    };
    var _opts = $.extend({}, {
      uploadSuccess: $.noop,
      cropSuccess: $.noop
    }, opts)
    $image.cropper(options);     
    var $inputImage = input;      
    var uploadedImageURL;      
    if (URL) {         // 给input添加监听
      $inputImage.change(function() {          
        var files = this.files;          
        var file;          
        if (!$image.data('cropper')) {            
          return;          
        }          
        if (files && files.length) {            
          file = files[0];             // 判断是否是图像文件
          if (/^image\/\w+$/.test(file.type)) {               // 如果URL已存在就先释放
            if (uploadedImageURL) {                
              URL.revokeObjectURL(uploadedImageURL);              
            }              
            uploadedImageURL = URL.createObjectURL(file);               // 销毁cropper后更改src属性再重新创建cropper
            var $baseImg = $('<img src="' + uploadedImageURL + '">');
            baseWidth = $baseImg[0].width;
            baseHeight = $baseImg[0].height;
            $image.cropper('destroy').attr('src', uploadedImageURL).cropper(options);              
            $inputImage.val('');
            $('.m-copper-wrap').show()
          } else {             
            window.alert('请选择一个图像文件！');           
          }         
        }       
      });      
    } else {        
      $inputImage.prop('disabled', true).addClass('disabled');      
    }


    $('body').on('click', '[data-action="cropper"]', function() {
      var base64 = getBase64()
      var file = dataURLtoFile(base64)
      _opts.cropSuccess(base64, file)
      $('.m-copper-wrap').hide();
    })

    $('body').on('click', '[data-action="upload"]', function() {
      var file = dataURLtoFile(getBase64())
      sendImg(file)
    })

    $('body').on('click', '[data-action="cancel"]', function() {
      $('.m-copper-wrap').hide();
    })

    function getBase64() {
      var result = $image.cropper('getCroppedCanvas', {        
        width: Math.min(500, baseWidth), // 裁剪后的长宽
        height: Math.min(500, baseHeight)     
      })
      return result.toDataURL('image/jpeg', 0.3); //转为base64
    }

    function dataURLtoFile(dataurl) { //将base64转换为文件
      var arr = dataurl.split(','),
        mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]),
        n = bstr.length,
        u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new File([u8arr], +new Date() + '.jpg', {
        type: mime
      });
    }

    function sendImg(file, cb) {
      var formData = new FormData();
      formData.append('file', file);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/v1/admin/common/file/upload', true);
      xhr.withCredentials = true;
      xhr.onreadystatechange = function() {
        if (this.status == 200) {
          if (this.readyState == 4) {
            _opts.uploadSuccess(JSON.parse(xhr.responseText));
            $('.m-copper-wrap').hide();
          }
        } else {

        }
      };
      xhr.send(formData);
    };
  }
  </script>
  <script>
  $.post('/api/v1/admin/login', {
    userName: 'zjadmin', //  zjadmin
    password: '123456', //  123456
    captcha: '12345',
    rememberMe: false
  }, function(res) {
    console.log(res)
  })
  $.cropperInit($('#input'), {
    uploadSuccess: function(res) {
      console.log(res)
    },
    cropSuccess: function(img, file) {
      console.log(img, file)
    }
  });
  </script>
</body>

</html>
