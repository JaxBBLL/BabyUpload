!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.BabyUpload=e()}(this,function(){"use strict";function p(t,e,o){var i,n,s,r=e.maxWidth,p=e.maxHeight;i=t,n=function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),n=parseFloat((t.width/t.height).toFixed(2));1<n?t.width:t.height;1<=n?p=r/n:r=p/n;var s=Math.min(r,t.width),a=Math.min(p,t.height);e.width=s,e.height=a,i.clearRect(0,0,s,a),i.drawImage(t,0,0,s,a),e.toBlob(function(t){o&&o(t)},"image/jpeg")},(s=new FileReader).onload=function(t){var e=document.createElement("img");e.onload=function(){n(e)},e.src=t.target.result},s.readAsDataURL(i)}HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,i){for(var n=atob(this.toDataURL(e,i).split(",")[1]),s=n.length,a=new Uint8Array(s),o=0;o<s;o++)a[o]=n.charCodeAt(o);t(new Blob([a],{type:e||"image/png"}))}});function l(t){if(!(this instanceof l))return new l(t);var e=function(t){for(var e=1,i=arguments.length;e<i;e++){var n=arguments[e]||{};for(var s in n)if(n.hasOwnProperty(s)){var a=n[s];void 0!==a&&(t[s]=a)}}return t}({},{isChangeUpload:!1,name:"file",isCompress:!1,maxWidth:500,maxHeight:500,multiple:!1,data:{},method:"POST",accept:"",withCredentials:!1,maxSize:0},t),a=this,i="string"==typeof e.el?document.querySelector(e.el):e.el;this._opts=e,this.eventMap=this.eventMap||{},this.files=[];var n,s,o,r=document.createElement("input");r.setAttribute("type","file"),r.setAttribute("name",i.name||""),this._opts.multiple&&r.setAttribute("multiple","multiple"),this._opts.accept&&r.setAttribute("accept",this._opts.accept),r.style.display="none",s=r,o=(n=i).parentNode,n.nextSibling?o.insertBefore(s,n.nextSibling):o.appendChild(s),i.addEventListener("click",function(t){r.value="",r.click()},!1),r.addEventListener("change",function(t){var e=Array.prototype.slice.call(this.files);a._opts.multiple?a.files=a.files.concat(e):a.files=e;var i=a.files.length;if(a._opts.isCompress)for(var n=[],s=0;s<a.files.length;s++)p(a.files[s],{maxWidth:a._opts.maxWidth,maxHeight:a._opts.maxHeight},function(t){n.push(t),0==--i&&(a.files=n,a._opts.isChangeUpload&&a.upload())});else a._opts.isChangeUpload&&a.upload();a.trigger("change",e,a.files)},!1)}function h(e){try{return JSON.parse(e)}catch(t){return{data:e}}}return l.prototype.upload=function(){if(this.trigger("beforeUpload",this.files),!this.files.length)return!1;for(var s=this._opts.url,a=this._opts.method,o=(this._opts.success,this._opts.error,this),r=[],p=0,l=this.files.length;p<this.files.length;p++){this.files[p];!function(t){var e=new FormData;for(var i in e.append(o._opts.name,o.files[p],+new Date+".jpg"),o._opts.data)e.append(i,o._opts.data[i]);var n=new XMLHttpRequest;n.open(a,s,!0),n.withCredentials=o._opts.withCredentials,n.onreadystatechange=function(){200==this.status?4==this.readyState&&(l-=1,r.push(h(this.responseText)),0===l&&o.trigger("success",r)):o.trigger("error",h(this.responseText))},n.send(e)}()}return this.files=[],this},l.prototype.remove=function(t){if(this.files.length)return t=void 0===t?0:t,this.files.splice(t,1),this},l.prototype.on=function(t,e){for(var i=t.split(" "),n="function"==typeof e,s=0;s<i.length;s++)this.eventMap[i[s]]=this.eventMap[i[s]]||[],n&&this.eventMap[i[s]].push(e);return this},l.prototype.trigger=function(t){var e=this.eventMap[t];if(e){for(var i=Array.prototype.slice.call(arguments,1),n=0;n<e.length;n++)e[n].apply(this.el,i);return this}},l});